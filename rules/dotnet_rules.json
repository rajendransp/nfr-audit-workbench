[
  {
    "id": "NFR-DOTNET-001",
    "title": "HttpClient call without CancellationToken",
    "category": "reliability",
    "top_level_category": "dotnet",
    "sub_category": "concurrency",
    "severity": "S2",
    "pattern": "\\b(HttpClient|_httpClient|client)\\.(GetAsync|PostAsync|PutAsync|DeleteAsync|SendAsync|GetFromJsonAsync|PostAsJsonAsync|PutAsJsonAsync)\\s*\\((?![^)]*\\b(CancellationToken|ct|stoppingToken|token|cancellationToken|requestAborted)\\b)[^)]*\\)",
    "include_globs": [
      "*.cs"
    ],
    "exclude_globs": [
      "**/bin/**",
      "**/obj/**",
      "**/Migrations/**",
      "**/*.g.cs",
      "**/*.designer.cs"
    ],
    "rationale": "HTTP calls in request/worker flows should propagate cancellation (RequestAborted/stoppingToken) to avoid wasted work after disconnects and to enable graceful shutdown.",
    "confidence_hint": 0.75,
    "enforcement_level": "review"
  },
  {
    "id": "NFR-DOTNET-002",
    "title": "EF Core async query without CancellationToken",
    "category": "reliability",
    "top_level_category": "dotnet",
    "sub_category": "concurrency",
    "severity": "S2",
    "pattern": "(?is)\\b(?:AnyAsync|ToListAsync|FirstAsync|FirstOrDefaultAsync|SingleAsync|SingleOrDefaultAsync|CountAsync|LongCountAsync|SumAsync|AverageAsync|MinAsync|MaxAsync|FindAsync|ExecuteUpdateAsync|ExecuteDeleteAsync)\\s*\\((?![^;]{0,800}\\b(?:cancellationToken|ct|token|requestAborted|HttpContext\\.RequestAborted|stoppingToken)\\b)[^;]{0,800}\\)\\s*(?:\\.ConfigureAwait\\s*\\(\\s*false\\s*\\))?\\s*;",
    "include_globs": [
      "*.cs"
    ],
    "exclude_globs": [
      "**/bin/**",
      "**/obj/**",
      "**/Migrations/**",
      "**/*.g.cs",
      "**/*.designer.cs"
    ],
    "rationale": "Async EF Core calls should pass CancellationToken to stop DB work when a request is aborted or a worker is shutting down.",
    "confidence_hint": 0.75,
    "enforcement_level": "review"
  },
  {
    "id": "NFR-DOTNET-003",
    "title": "Blocking wait primitives in async-capable code",
    "category": "performance",
    "top_level_category": "dotnet",
    "sub_category": "concurrency",
    "severity": "S2",
    "confidence_hint": 0.75,
    "pattern": "(\\.GetAwaiter\\s*\\(\\)\\.GetResult\\s*\\(\\)|\\.Wait\\s*\\(|\\bTask\\.Wait(All|Any)\\s*\\()",
    "ignore_comment_lines": true,
    "include_globs": [
      "*.cs"
    ],
    "exclude_globs": [
      "**/bin/**",
      "**/obj/**",
      "**/*.g.cs",
      "**/*.designer.cs",
      "**/Migrations/**"
    ],
    "rationale": "Blocking wait primitives (.Wait / GetAwaiter().GetResult / Task.Wait*) can cause deadlocks and thread pool starvation. High-signal even with regex; still review unless confirmed in hot paths.",
    "enforcement_level": "review"
  },
  {
    "id": "NFR-DOTNET-003B",
    "title": "Task.Result on async call result",
    "category": "performance",
    "top_level_category": "dotnet",
    "sub_category": "concurrency",
    "severity": "S3",
    "confidence_hint": 0.45,
    "pattern": "(?is)\\b[A-Za-z_][A-Za-z0-9_]*Async\\s*\\([\\s\\S]{0,600}\\)\\s*\\.\\s*Result\\b",
    "ignore_comment_lines": true,
    "include_globs": [
      "*.cs"
    ],
    "exclude_globs": [
      "**/bin/**",
      "**/obj/**",
      "**/*.g.cs",
      "**/*.designer.cs",
      "**/Migrations/**"
    ],
    "rationale": "Accessing .Result on an async call result can block threads and deadlock in some contexts. Regex is heuristic (multi-line/lambda-safe); treat as review and confirm callsite.",
    "enforcement_level": "review"
  },
  {
    "id": "NFR-DOTNET-004",
    "title": "Thread.Sleep used",
    "category": "performance",
    "top_level_category": "dotnet",
    "sub_category": "performance",
    "severity": "S2",
    "confidence_hint": 0.95,
    "pattern": "\\bThread\\.Sleep\\s*\\(",
    "include_globs": [
      "*.cs"
    ],
    "exclude_globs": [
      "**/bin/**",
      "**/obj/**"
    ],
    "rationale": "Sleep blocks threads and harms throughput; prefer async delay with cancellation.",
    "enforcement_level": "review"
  },
  {
    "id": "NFR-DOTNET-005",
    "title": "new HttpClient in code path",
    "category": "scalability",
    "top_level_category": "dotnet",
    "sub_category": "loading",
    "severity": "S2",
    "confidence_hint": 0.85,
    "pattern": "\\bnew\\s+HttpClient\\s*\\(",
    "include_globs": [
      "*.cs"
    ],
    "exclude_globs": [
      "**/bin/**",
      "**/obj/**",
      "**/*Tests*.cs",
      "**/Program.cs",
      "**/*HttpClientFactory*.cs",
      "**/*HttpClientBuilder*.cs",
      "**/Startup.cs"
    ],
    "rationale": "Prefer IHttpClientFactory/typed clients; repeated HttpClient allocation can cause socket exhaustion. Excludes common factory/builder/bootstrap locations.",
    "enforcement_level": "review"
  },
  {
    "id": "NFR-DOTNET-006",
    "title": "ExecuteSqlRaw without CancellationToken",
    "category": "reliability",
    "top_level_category": "dotnet",
    "sub_category": "concurrency",
    "severity": "S2",
    "pattern": "\\.ExecuteSqlRaw(Async)?\\s*\\((?![^)]*\\bCancellationToken\\b)(?![^)]*\\bct\\b)(?![^)]*\\bstoppingToken\\b)[^)]*\\)",
    "include_globs": [
      "*.cs"
    ],
    "exclude_globs": [
      "**/bin/**",
      "**/obj/**",
      "**/Migrations/**"
    ],
    "rationale": "Raw SQL operations should honor cancellation in services and APIs.",
    "confidence_hint": 0.7,
    "enforcement_level": "review"
  },
  {
    "id": "NFR-DOTNET-007",
    "title": "High command timeout configured",
    "category": "reliability",
    "top_level_category": "dotnet",
    "sub_category": "loading",
    "severity": "S3",
    "pattern": "\\b(CommandTimeout|SetCommandTimeout)\\b[^\\n]*\\b([3-9][0-9]{2,}|[1-9][0-9]{3,})\\b",
    "include_globs": [
      "*.cs",
      "*.json",
      "*.config",
      "appsettings*.json"
    ],
    "exclude_globs": [
      "**/bin/**",
      "**/obj/**"
    ],
    "rationale": "Very high timeouts can mask upstream latency and propagate incidents.",
    "confidence_hint": 0.5,
    "enforcement_level": "review"
  },
  {
    "id": "NFR-DOTNET-008",
    "title": "Task.Delay without CancellationToken",
    "category": "reliability",
    "top_level_category": "dotnet",
    "sub_category": "concurrency",
    "severity": "S2",
    "pattern": "\\bTask\\.Delay\\s*\\((?![^)]*\\bCancellationToken\\b)(?![^)]*\\bct\\b)(?![^)]*\\bstoppingToken\\b)[^)]*\\)",
    "include_globs": [
      "*.cs"
    ],
    "exclude_globs": [
      "**/bin/**",
      "**/obj/**"
    ],
    "rationale": "Delays in workers and retries should be cancellable for graceful shutdown.",
    "confidence_hint": 0.7,
    "enforcement_level": "review"
  },
  {
    "id": "NFR-DOTNET-009",
    "title": "Unbounded Parallel.ForEach",
    "category": "scalability",
    "top_level_category": "dotnet",
    "sub_category": "concurrency",
    "severity": "S2",
    "pattern": "\\bParallel\\.ForEach\\s*\\((?![\\s\\S]{0,160}ParallelOptions)[\\s\\S]{0,60}",
    "include_globs": [
      "*.cs"
    ],
    "exclude_globs": [
      "**/bin/**",
      "**/obj/**"
    ],
    "rationale": "Unbounded Parallel.ForEach can overwhelm CPU/threadpool and downstream services. This rule focuses on calls that do not appear to pass ParallelOptions.",
    "confidence_hint": 0.6,
    "enforcement_level": "review"
  },
  {
    "id": "NFR-DOTNET-010",
    "title": "Potential N+1 query inside loop",
    "category": "performance",
    "top_level_category": "dotnet",
    "sub_category": "loading",
    "severity": "S3",
    "pattern": "\\b(for(each)?|while)\\b[\\s\\S]{0,400}\\.(FirstOrDefaultAsync|SingleOrDefaultAsync|ToListAsync|AnyAsync|CountAsync)\\s*\\(",
    "include_globs": [
      "*.cs"
    ],
    "exclude_globs": [
      "**/bin/**",
      "**/obj/**"
    ],
    "rationale": "Repeated DB calls in loops can create N+1 latency and load issues.",
    "confidence_hint": 0.5,
    "enforcement_level": "review"
  },
  {
    "id": "NFR-DOTNET-011",
    "title": "async void method",
    "category": "reliability",
    "top_level_category": "dotnet",
    "sub_category": "concurrency",
    "severity": "S1",
    "confidence_hint": 0.95,
    "pattern": "\\basync\\s+void\\s+[A-Za-z_][A-Za-z0-9_]*\\s*\\(",
    "include_globs": [
      "*.cs"
    ],
    "exclude_globs": [
      "**/bin/**",
      "**/obj/**",
      "**/*Designer.cs"
    ],
    "rationale": "async void methods cannot be awaited and exceptions bypass normal task error handling.",
    "enforcement_level": "hard_fail"
  },
  {
    "id": "NFR-DOTNET-012",
    "title": "Fire-and-forget background work pattern",
    "category": "reliability",
    "top_level_category": "dotnet",
    "sub_category": "concurrency",
    "severity": "S2",
    "pattern": "(?m)(^|\\s)(?:_|\\w+)?\\s*=\\s*Task\\.Run\\s*\\(|(?<!await\\s)Task\\.Run\\s*\\(|\\bTask\\.Factory\\.StartNew\\s*\\(|\\bnew\\s+Thread\\s*\\(",
    "include_globs": [
      "*.cs"
    ],
    "exclude_globs": [
      "**/bin/**",
      "**/obj/**",
      "**/*Tests*.cs"
    ],
    "rationale": "Unobserved background work (Task.Run/StartNew/new Thread) can hide failures and outlive request-scoped resources. Review whether work is awaited/observed and cancellation is propagated.",
    "confidence_hint": 0.55,
    "enforcement_level": "review"
  },
  {
    "id": "NFR-DOTNET-013",
    "title": "Explicit CancellationToken.None",
    "category": "reliability",
    "top_level_category": "dotnet",
    "sub_category": "concurrency",
    "severity": "S2",
    "confidence_hint": 0.75,
    "pattern": "\\bCancellationToken\\.None\\b",
    "ignore_comment_lines": true,
    "include_globs": [
      "*.cs"
    ],
    "exclude_globs": [
      "**/bin/**",
      "**/obj/**",
      "**/*Tests*.cs"
    ],
    "rationale": "Hardcoding non-cancellable operations can block graceful shutdown and wasted work cancellation.",
    "enforcement_level": "review"
  },
  {
    "id": "NFR-DOTNET-014",
    "title": "Empty catch block",
    "category": "reliability",
    "top_level_category": "dotnet",
    "sub_category": "loading",
    "severity": "S2",
    "pattern": "\\bcatch\\s*\\((?![^\\)]*OperationCanceledException)[^\\)]*\\)\\s*\\{\\s*\\}",
    "include_globs": [
      "*.cs"
    ],
    "exclude_globs": [
      "**/bin/**",
      "**/obj/**"
    ],
    "rationale": "Empty catch blocks swallow failures; allow empty catch only for OperationCanceledException when intentionally ignored.",
    "confidence_hint": 0.8,
    "enforcement_level": "review"
  },
  {
    "id": "NFR-DOTNET-015",
    "title": "Synchronous file read in request path",
    "category": "performance",
    "top_level_category": "dotnet",
    "sub_category": "performance",
    "severity": "S2",
    "pattern": "\\b(File\\.ReadAllText|File\\.ReadAllBytes|File\\.OpenRead)\\s*\\(",
    "include_globs": [
      "*.cs"
    ],
    "exclude_globs": [
      "**/bin/**",
      "**/obj/**",
      "**/*Tests*.cs"
    ],
    "rationale": "Sync file I/O can block thread pool threads and reduce throughput.",
    "confidence_hint": 0.7,
    "enforcement_level": "review"
  },
  {
    "id": "NFR-DOTNET-016",
    "title": "LINQ materialization before filtering",
    "category": "performance",
    "top_level_category": "dotnet",
    "sub_category": "performance",
    "severity": "S3",
    "pattern": "\\.ToList\\s*\\(\\s*\\)\\s*\\.(Where|Select|OrderBy|GroupBy)\\s*\\(",
    "include_globs": [
      "*.cs"
    ],
    "exclude_globs": [
      "**/bin/**",
      "**/obj/**"
    ],
    "rationale": "Materializing early increases allocations and memory pressure.",
    "confidence_hint": 0.5,
    "enforcement_level": "review"
  },
  {
    "id": "NFR-DOTNET-017",
    "title": "Large in-memory collection materialization",
    "category": "performance",
    "top_level_category": "dotnet",
    "sub_category": "loading",
    "severity": "S3",
    "confidence_hint": 0.4,
    "pattern": "\\b(_db\\w*|dbContext|context)\\b[\\s\\S]{0,240}\\.(ToArrayAsync|ToListAsync|ToArray|ToList)\\s*\\(",
    "include_globs": [
      "*.cs"
    ],
    "exclude_globs": [
      "**/bin/**",
      "**/obj/**",
      "**/*Tests*.cs"
    ],
    "rationale": "Large materializations can cause memory spikes and GC churn under load.",
    "enforcement_level": "review"
  },
  {
    "id": "NFR-DOTNET-018",
    "title": "Missing pagination in query endpoint",
    "category": "scalability",
    "top_level_category": "dotnet",
    "sub_category": "loading",
    "severity": "S3",
    "pattern": "\\b(IQueryable<|DbSet<)[\\s\\S]{0,300}\\.(ToListAsync|ToList)\\s*\\(",
    "include_globs": [
      "**/*Controller*.cs",
      "**/*Endpoint*.cs",
      "**/*Endpoints*.cs"
    ],
    "exclude_globs": [
      "**/bin/**",
      "**/obj/**",
      "**/Migrations/**"
    ],
    "rationale": "Potential unbounded query materialization in API/endpoint code. Prefer pagination (Skip/Take/page) or bounded filters. Regex-only: treat as review.",
    "confidence_hint": 0.35,
    "enforcement_level": "review"
  },
  {
    "id": "NFR-DOTNET-019",
    "title": "Parallel.ForEachAsync without cancellation token",
    "category": "reliability",
    "top_level_category": "dotnet",
    "sub_category": "concurrency",
    "severity": "S2",
    "pattern": "(?is)\\bParallel\\.ForEachAsync\\s*\\((?![\\s\\S]{0,900}\\b(?:cancellationToken|token|ct|requestAborted|HttpContext\\.RequestAborted|stoppingToken|CancellationToken)\\b)(?![\\s\\S]{0,900}\\bParallelOptions\\b)[\\s\\S]{0,900}\\)\\s*(?:\\.ConfigureAwait\\s*\\(\\s*false\\s*\\))?\\s*;?",
    "include_globs": [
      "*.cs"
    ],
    "exclude_globs": [
      "**/bin/**",
      "**/obj/**"
    ],
    "rationale": "Parallel.ForEachAsync should be cancellable. Regex checks within the same statement (multi-line/lambda-safe) for a CancellationToken-like argument or ParallelOptions; otherwise flags for review.",
    "confidence_hint": 0.72,
    "enforcement_level": "review"
  },
  {
    "id": "NFR-DOTNET-020",
    "title": "Read query without AsNoTracking",
    "category": "performance",
    "top_level_category": "dotnet",
    "sub_category": "performance",
    "severity": "S4",
    "pattern": "\\b_db\\w*\\.[A-Za-z0-9_]+\\b(?![\\s\\S]{0,160}\\b(AsNoTracking|AsTracking)\\s*\\()(?![\\s\\S]{0,160}\\bSelect\\s*\\()([\\s\\S]{0,200})\\.(ToListAsync|FirstOrDefaultAsync|SingleOrDefaultAsync|AnyAsync|CountAsync)\\s*\\(",
    "include_globs": [
      "*.cs"
    ],
    "exclude_globs": [
      "**/bin/**",
      "**/obj/**",
      "**/Migrations/**"
    ],
    "rationale": "AsNoTracking can reduce change-tracker overhead for large read-only entity queries. This is contextual (writes/projections/tests); treat as low-priority review.",
    "confidence_hint": 0.35,
    "enforcement_level": "review"
  },
  {
    "id": "NFR-DOTNET-021",
    "title": "Synchronous JSON serialization in hot path (review)",
    "category": "performance",
    "top_level_category": "dotnet",
    "sub_category": "performance",
    "severity": "S3",
    "confidence_hint": 0.55,
    "pattern": "\\b(JsonConvert\\.SerializeObject|JsonConvert\\.DeserializeObject(?:<[^>]+>)?|System\\.Text\\.Json\\.JsonSerializer\\.(Serialize|Deserialize))\\s*\\(",
    "include_globs": [
      "*.cs"
    ],
    "exclude_globs": [
      "**/bin/**",
      "**/obj/**",
      "**/*Tests*.cs",
      "**/Migrations/**",
      "**/*.g.cs",
      "**/*.designer.cs"
    ],
    "rationale": "Manual sync JSON serialization can add CPU/allocations in hot paths. In API/controller paths prefer returning objects and framework serialization; keep manual serialization for targeted hashing/cache/log use-cases.",
    "enforcement_level": "review"
  },
  {
    "id": "NFR-DOTNET-022",
    "title": "Async call result not awaited or returned",
    "category": "reliability",
    "top_level_category": "dotnet",
    "sub_category": "concurrency",
    "severity": "S2",
    "pattern": "(?m)^\\s*(?!await\\b)(?!return\\b)(?!_\\s*=)(?!var\\s+_\\s*=)(?!//)[A-Za-z_][A-Za-z0-9_\\.<>]*Async\\s*\\([^;\\n]*\\)\\s*(?:\\.ConfigureAwait\\s*\\(\\s*false\\s*\\))?\\s*;",
    "ignore_comment_lines": true,
    "include_globs": [
      "*.cs"
    ],
    "exclude_globs": [
      "**/bin/**",
      "**/obj/**",
      "**/*Tests*.cs",
      "**/*.g.cs",
      "**/*.designer.cs"
    ],
    "rationale": "Standalone async invocations that are neither awaited nor returned can hide failures or complete later than expected. This rule catches likely fire-and-forget mistakes such as calling AddRangeAsync(...) without await/return.",
    "confidence_hint": 0.7,
    "enforcement_level": "review"
  }
]
